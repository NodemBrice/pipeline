pipeline {
    agent any
    triggers { githubPush() }
    environment {
        SLACK_CHANNEL = '#jenkins-cm'
        APP_NAME = 'flask-app'
        IMAGE_TAG = "v${BUILD_NUMBER}"
    }

    stages {
        stage('Clone') {
            steps {
                echo 'Clonage du code...'
                checkout scmGit(
                    branches: [[name: 'dev']],
                    userRemoteConfigs: [[url: 'https://github.com/NodemBrice/pipeline.git']]
                )
            }
            post {
                always {
                    echo "POST: Tentative d'envoi Slack pour Clone..."
                    try {
                        notifySlack("Clone terminé", "good")
                    } catch (err) {
                        echo "SLACK ERROR: ${err}"
                    }
                }
            }
        }

        stage('Build') {
            steps {
                echo 'Construction de l\'image Docker...'
                sh "docker build -t ${APP_NAME}:${IMAGE_TAG} ."
            }
            post {
                always {
                    echo "POST: Tentative d'envoi Slack pour Build..."
                    try {
                        notifySlack("Build OK → ${IMAGE_TAG}", "good")
                    } catch (err) {
                        echo "SLACK ERROR: ${err}"
                    }
                }
            }
        }

        stage('Deploy') {
            steps {
                echo 'Déploiement...'
                sh """
                docker stop ${APP_NAME} || true
                docker rm ${APP_NAME} || true
                docker run -d --name ${APP_NAME} -p 5000:5000 ${APP_NAME}:${IMAGE_TAG}
                """
            }
            post {
                always {
                    echo "POST: Tentative d'envoi Slack pour Deploy..."
                    try {
                        notifySlack("Deploy OK → http://localhost:5000", "good")
                        notifySlack("Pipeline COMPLET !", "good")
                    } catch (err) {
                        echo "SLACK ERROR: ${err}"
                    }
                }
            }
        }
    }

    post {
        always {
            echo "Pipeline terminé. Build #${BUILD_NUMBER}"
        }
    }
}

def notifySlack(message, color) {
    slackSend(
        channel: env.SLACK_CHANNEL,
        color: color,
        message: "*${env.JOB_NAME}* #${env.BUILD_NUMBER} | ${message}\n> Branche: `dev` | <${env.BUILD_URL}|Logs>"
    )
}